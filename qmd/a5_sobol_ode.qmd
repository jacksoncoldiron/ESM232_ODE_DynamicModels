---
title: "Sobol with an OBE"
author: "Jackson Coldiron and Kaitlin Castor"
editor: visual
format: 
  html:
    code-fold: true
    embed-resources: true
    theme: sandstone
    toc: false
execute:
  freeze: auto 
  warning: false
  message: false
---

## Introduction

## Model Implementation

```{r}
# Load required libraries
library(tidyverse)
library(deSolve)
library(sensitivity)
library(knitr)
library(kableExtra)
library(here)
```

#### Model Run

```{r}
# Bring in the model
source(here("R","forestgrowth.R"))

# Set the parameters
tm <- seq(from = 1, to = 300)
Pinitial <- 10
gps <- list(thres = 50, K = 250, r = 0.01, g = 2)
res <- ode(Pinitial, tm, forest, gps)
colnames(res) <- c("time", "carbon")

```

#### Results with No Uncertainty

```{r}
#| fig-width: 10
#| fig-cap: "__Figure 1: Growth in Forest Size Over 300 Years with No Uncertainty __: Holding the parameters fixed with given values, forest growth in terms of kilograms of Carbon is shown over 300 years. Forest size grows exponetially until it reaches the canopy closure threshold at 50 kg C. Then growth follows a linear model based on a carrying capacity of 250 kg C."

# Graph the results with a line signally carrying capacity
no_uncert <- ggplot(as.data.frame(res), aes(time, carbon)) +
  geom_point() +
  labs(x = "Time (years)",
       y = "Forest Size (kg C)") +
  theme_minimal()

no_uncert
```

## Sensitivity Analysis

```{r}
# Set distributions for parameters
# Assume parameters are normally distributed with a sd of 10% of mean value
np <- 1000

r <- rnorm(mean = 0.01, sd = 0.1 * 0.01, n = np)
g <- rnorm(mean = 2, sd = 0.1 * 2, n = np)
K <- rnorm(mean = 250, sd = 0.1 * 250, n = np)
thres <- rnorm(mean = 50, sd = 0.1 * 50, n = np)

# Input sample parameters into a df
X1 <- cbind.data.frame(r, g, K, thres)

# Sobol requires two sets of sample parameters
# Repeat sampling
r <- rnorm(mean = 0.01, sd = 0.1 * 0.01, n = np)
g <- rnorm(mean = 2, sd = 0.1 * 2, n = np)
K <- rnorm(mean = 250, sd = 0.1 * 250, n = np)
thres <- rnorm(mean = 50, sd = 0.1 * 50, n = np)

# Input sample parameters into a df
X2 <- cbind.data.frame(r, g, K, thres)
```

#### Sobol

```{r}
# Create a sobol object and get sets of parameters for running the model
sens_forest <- sobolSalt(model = NULL, X1, X2, nboot = 300)
colnames(sens_forest$X) <- c("r", "g", "K", "thres")

# Define the metric function
metric <- function(res) {
  max <- max(res$carbon)
  return(list(max = max))
}

# Use a wrapper function to return just the map
p_wrapper <- function(r, g, K, thres, Pinitial, simtimes, func, metric) {
  parms <- list(r = r, K = K, g = g, thres = thres)
  result <- ode(y = Pinitial, times = simtimes, func = func, parms = parms)
  result <- as.data.frame(result)
  colnames(result) <- c("time", "carbon")
  # get metrics
  metrics <- metric(as.data.frame(result))
  return(metrics$max)
}

# Run the model with the parameters
allresults <- as.data.frame(sens_forest$X) |>
  pmap(p_wrapper, Pinitial = Pinitial, simtimes = tm, func = forest, metric = metric)
```

#### Visualize Results

```{r}
#| fig-width: 10
#| fig-cap: "__Figure 2: Maximum Forest Size Boxplot __: A boxplot shows the maximum carbon for 300 years, a proxy for maximum forest size, with uncertainty. Parameters vary for pre canopy closure growth rate, post-canopy closure growth rate, and canopy closure threshold and carrying capacity. Given the uncertainty in our parameters, maximum forest size averages at 182 kg C. The interquartile range is 171 - 192 kg C. The maximum and minimum for maximum forest size are 237 and 121 kg C, respectively."

# Convert vector of results to a data frame for plotting
allres <- data.frame(max_C = unlist(allresults))

#create a boxplot
ggplot(allres, aes(y = max_C)) +
  geom_boxplot(fill = "steelblue") +
  labs(title = "Distribution of Maximum Carbon Stock (C)",
       y = "Max Carbon (kgC)") +
  theme_minimal()

```

#### Sobol Indices

```{r}
#| fig-width: 10
#| fig-cap: "__Table 1: Sobel Indices __: Sobel Indices for maximum carbon for 300 years, a proxy for maximum forest size. The First-order index shows the main effect of parameters without co-varience."

sens_forest$y <- unlist(allresults)
sens_forest <- sensitivity::tell(sens_forest, sens_forest$Y)

# first-order index (main effect without co-variance)
rownames(sens_forest$S) <- c("r", "g", "k", "thresh")
sens_forest$S

kable(sens_forest$S, 
      caption = "first-order index") |> 
  kable_styling(position = "left")
```

```{r}
#| fig-width: 10
#| fig-cap: "__Table 2: Sobel Indices __: Sobel Indices for maximum carbon for 300 years, a proxy for maximum forest size. The total sensitivity index shows how the parameters affect the model, accounting for when all parameters interact together."

# total sensitivity index -note that this partitions the output variance
rownames(sens_forest$T) <- c("r", "g", "k", "thresh")
sens_forest$T

kable(sens_forest$T, 
      caption = "total sensitivity index") |> 
  kable_styling(position = "right")
```

## Discussion

Our sobol indices quantify how our different parameters contribute to the variance we observe in our maximum forest size model. Pre canopy closure growth rate (r) and carrying capacity (k) have equally the strongest individual and interaction parameter effects (35%) on the maximum forest size. Canopy closure threshold (thresh) is the lowest individual (10%) and interacting parameter (7%), suggesting minimal affect on maximum forest size. As climate change alters the variance of our parameters, specifically pre canopy closure growth rate and carrying capacity, it will in turn affect maximum forest size.
